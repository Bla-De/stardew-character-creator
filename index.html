<html>
  <head>
    <script src="https://cdn.jsdelivr.net/npm/melonjs@8.0.1/dist/melonjs.min.js"></script>
  </head>
  <body>
    <div style="display: flex">
      <div id="preview"></div>
      <div id="inputs" style="flex-grow: 1; padding: 25px">
        <label for="eye_col">Eye color</label>
        <input name="eye_col" id="eye_col" type="color" value="#784034">
        <label for="hair_col">Hair color</label>
        <input name="hair_col" id="hair_col" type="color" value="#BF5432">
        <label for="pant_col">Pants color</label>
        <input name="pant_col" id="pant_col" type="color" value="#2F5DB5">
        <label for="hair">Hair</label>
        <input type="number" name="hair" id="hair" value="1" min="1" max="74">
        <label for="shirt">Shirt</label>
        <input type="number" name="shirt" id="shirt" value="1" min="1" max="112">
        <label for="pant">Pants</label>
        <input type="number" name="pant" id="pant" value="1" min="1" max="4">
        <label for="pant">Accessory</label>
        <input type="number" name="accessory" id="accessory" value="1" min="1" max="20">
        <button id="copy">Copy to clipboard</button>
        <p><i>Why no options for skin?</i></p><p>Because CA does some insane pixel matching color replacement on the base sprite that this open source engine doesn't have the capability to do</p>
        <p><i>Why do the eyes not update?</i></p><p>Because I am lazy, they will soon</p>
        <p><a href="https://github.com/robopossum/stardew-character-creator">Source</a></p>
      </div>
    </div>
<script>
//3, 57, 47
//4, 74, 75
//61, 74, 71
const resources = [
  {
    name: 'male',
    type: 'image',
    src: 'farmer_base.png'
  },
  {
    name: 'female',
    type: 'image',
    src: 'farmer_girl_base.png'
  },
  {
    name: 'accessory',
    type: 'image',
    src: 'accessories.png'
  },
  {
    name: 'shirt',
    type: 'image',
    src: 'shirts.png'
  },
  {
    name: 'pants',
    type: 'image',
    src: 'pants.png'
  },
  {
    name: 'hair_basic',
  type: 'image',
  src: 'hairstyles.png'
  },
  {
    name: 'hair_fancy',
    type: 'image',
    src: 'hairstyles2.png'
  }
];

const shirtIndexes = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 128, 129, 130, 131, 132, 133, 134, 135, 136, 137, 138, 139, 140, 141, 142, 143, 256, 257, 258, 259, 260, 261, 262, 263, 264, 265, 266, 267, 268, 269, 270, 271, 384, 385, 386, 387, 388, 389, 390, 391, 392, 393, 394, 395, 396, 397, 398, 399, 512, 513, 514, 515, 516, 517, 518, 519, 520, 521, 522, 523, 524, 525, 526, 527, 640, 641, 642, 643, 644, 645, 646, 647, 648, 649, 650, 651, 652, 653, 654, 655, 768, 769, 770, 771, 772, 773, 774, 775, 776, 777, 778, 779, 780, 781, 782, 783];
const hairIndexes = [0, 1, 2, 3, 4, 5, 6, 7, 24, 25, 26, 27, 28, 29, 30, 31, 48, 49, 50, 51, 52, 53, 54, 55, 72, 73, 74, 75, 76, 77, 78, 79, 96, 97, 98, 99, 100, 101, 102, 103, 120, 121, 122, 123, 124, 125, 126, 127, 144, 145, 146, 147, 148, 149, 150, 151];
const hairFancyIndexes = [0, 1, 2, 3, 4, 5, 6, 7, 32, 33, 34, 35, 36, 37, 38, 39, 64, 65];
const accessoryIndexes = [0, 1, 2, 3, 4, 5, 6, 7, 16, 17, 18, 19, 20, 21, 22, 23, 32, 33, 34, 35];
me.device.onReady(function () {
  // initialize the display canvas once the device/browser is ready
  if (!me.video.init(64, 64, {parent: document.getElementById('preview'), scale: "auto", scaleMethod: "fit"})) {
    alert("Your browser does not support HTML5 canvas.");
    return;
  }
  
  document.getElementsByTagName('canvas')[0].style.width = '256px';
  document.getElementsByTagName('canvas')[0].style.height = '256px';

  me.loader.preload(resources, loaded);
});

function loaded() {
  document.getElementById('copy').addEventListener('click', () => {
    const vals = [
      1,
      document.getElementById('hair').value,
      document.getElementById('shirt').value,
      document.getElementById('pant').value,
      document.getElementById('accessory').value
    ];
    const eye_col = document.getElementById('eye_col').value;
    vals.push(...rgb2hsv(
      parseInt("0x" + eye_col.slice(1,3)) / 255,
      parseInt("0x" + eye_col.slice(3,5)) / 255,
      parseInt("0x" + eye_col.slice(5,7)) / 255
    ));
    const hair_col = document.getElementById('hair_col').value;
    vals.push(...rgb2hsv(
      parseInt("0x" + hair_col.slice(1,3)) / 255,
      parseInt("0x" + hair_col.slice(3,5)) / 255,
      parseInt("0x" + hair_col.slice(5,7)) / 255
    ));
    const pant_col = document.getElementById('pant_col').value;
    vals.push(...rgb2hsv(
      parseInt("0x" + pant_col.slice(1,3)) / 255,
      parseInt("0x" + pant_col.slice(3,5)) / 255,
      parseInt("0x" + pant_col.slice(5,7)) / 255
    ));
    vals.push(1);
    navigator.clipboard.writeText(vals.join());
  });
  me.game.world.addChild(new me.ColorLayer("background", "#51a8f5"));
  const male = new me.Sprite(32, 32, {
    image: 'male',
    framewidth: 16,
    frameheight: 32,
    anchorPoint: new me.Vector2d(0.5, 0.5)
  });
  male.addAnimation('front', [0]);
  male.setCurrentAnimation('front');
  me.game.world.addChild(male);
  
  const shirt = new me.Sprite(32, 35, {
    image: 'shirt',
    framewidth: 8,
    frameheight: 8,
    anchorPoint: new me.Vector2d(0.5, 0.5)
  });
  shirtIndexes.forEach((frameIndex, index) => {
    shirt.addAnimation(index + 1, [frameIndex]);
  });
  shirt.setCurrentAnimation(1);
  me.game.world.addChild(shirt);
  
  document.getElementById('shirt').addEventListener('change', (e) => {
    shirt.setCurrentAnimation(e.target.value);
  });
  
  const pant = new me.Sprite(32, 32, {
    image: 'pants',
    framewidth: 16,
    frameheight: 32,
    anchorPoint: new me.Vector2d(0.5, 0.5)
  });
  pant.addAnimation(1, [0]);
  pant.addAnimation(2, [12]);
  pant.addAnimation(3, [24]);
  pant.addAnimation(4, [36]);
  pant.setCurrentAnimation(1);
  me.game.world.addChild(pant);
  
  document.getElementById('pant_col').addEventListener('change', (e) => {
    pant.tint.setColor(
      parseInt("0x" + e.target.value.slice(1,3)),
      parseInt("0x" + e.target.value.slice(3,5)),
      parseInt("0x" + e.target.value.slice(5,7))
    );
  });
  
  document.getElementById('pant').addEventListener('change', (e) => {
    pant.setCurrentAnimation(e.target.value);
  });
  
  document.getElementById('pant_col').dispatchEvent(new Event('change'));
  
  const arms = new me.Sprite(32, 32, {
    image: 'male',
    framewidth: 16,
    frameheight: 32,
    anchorPoint: new me.Vector2d(0.5, 0.5)
  });
  arms.addAnimation('front', [6]);
  arms.setCurrentAnimation('front');
  me.game.world.addChild(arms);
  
  const hair = new me.Sprite(32, 33, {
    image: 'hair_basic',
    framewidth: 16,
    frameheight: 32,
    anchorPoint: new me.Vector2d(0.5, 0.5)
  });
  hairIndexes.forEach((frameIndex, index) => {
    hair.addAnimation(index + 1, [frameIndex]);
  });
  hair.setCurrentAnimation(1);
  me.game.world.addChild(hair);
  
  const hairfancy = new me.Sprite(32, 33, {
    image: 'hair_fancy',
    framewidth: 16,
    frameheight: 32,
    anchorPoint: new me.Vector2d(0.5, 0.5)
  });
  hairFancyIndexes.forEach((frameIndex, index) => {
    hairfancy.addAnimation(index + hairIndexes.length + 1, [frameIndex]);
  });
  hairfancy.setCurrentAnimation(hairIndexes.length + 1);
  hairfancy.alpha = 0;
  me.game.world.addChild(hairfancy);
  
  document.getElementById('hair_col').addEventListener('change', (e) => {
    hair.tint.setColor(
      parseInt("0x" + e.target.value.slice(1,3)),
      parseInt("0x" + e.target.value.slice(3,5)),
      parseInt("0x" + e.target.value.slice(5,7))
    );
    hairfancy.tint.setColor(
      parseInt("0x" + e.target.value.slice(1,3)),
      parseInt("0x" + e.target.value.slice(3,5)),
      parseInt("0x" + e.target.value.slice(5,7))
    );
    document.getElementById('accessory').dispatchEvent(new Event('change'));
  });
  
  document.getElementById('hair').addEventListener('change', (e) => {
    if (e.target.value > hairIndexes.length) {
      hairfancy.setCurrentAnimation(e.target.value);
      hair.alpha = 0;
      hairfancy.alpha = 1;
    } else {
      hair.setCurrentAnimation(e.target.value);
      hair.alpha = 1;
      hairfancy.alpha = 0;
    }
  });
  
  document.getElementById('hair_col').dispatchEvent(new Event('change'));
  
  const accessory = new me.Sprite(32, 26, {
    image: 'accessory',
    framewidth: 16,
    frameheight: 16,
    anchorPoint: new me.Vector2d(0.5, 0.5)
  });
  accessoryIndexes.forEach((frameIndex, index) => {
    accessory.addAnimation(index + 2, [frameIndex]);
  });
  accessory.setCurrentAnimation(21);
  me.game.world.addChild(accessory);
  
  document.getElementById('accessory').addEventListener('change', (e) => {
    if (e.target.value === '1') {
      accessory.setCurrentAnimation(21);
      accessory.tint.setColor(255, 255, 255);
    } else {
      if (e.target.value < 8) {
        const hair_col = document.getElementById('hair_col').value;
        accessory.tint.setColor(
          parseInt("0x" + hair_col.slice(1,3)),
          parseInt("0x" + hair_col.slice(3,5)),
          parseInt("0x" + hair_col.slice(5,7))
        );
      } else {
        accessory.tint.setColor(255, 255, 255);
      }
      accessory.setCurrentAnimation(e.target.value);
    }
  });
}

function rgb2hsv(r,g,b) {
  let v=Math.max(r,g,b), c=v-Math.min(r,g,b);
  let h= c && ((v==r) ? (g-b)/c : ((v==g) ? 2+(b-r)/c : 4+(r-g)/c)); 
  return [parseInt(((60*(h<0?h+6:h)) / 360) * 100), parseInt((v&&c/v) * 100), parseInt(v * 100)];
}
</script>
  </body>
</html>
